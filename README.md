# cubesat-db

[![stability](https://img.shields.io/badge/stability-experimental-orange.svg?style=flat-square)](https://nodejs.org/api/documentation.html#documentation_stability_index)
[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg?style=flat-square)](https://github.com/feross/standard)

<!-- [![npm version](https://img.shields.io/npm/v/@garbados/cubesat-db.svg?style=flat-square)](https://www.npmjs.com/package/cubesat-db) -->

<!-- [![build status](https://img.shields.io/travis/garbados/cubesat-db/master.svg?style=flat-square)](https://travis-ci.org/garbados/cubesat-db) -->

<!-- [![test coverage](https://img.shields.io/coveralls/github/garbados/cubesat-db/master.svg?style=flat-square)](https://coveralls.io/github/garbados/cubesat-db) -->

<!-- [![greenkeeper](https://badges.greenkeeper.io/garbados/cubesat-db.svg)](https://greenkeeper.io/) -->

[pouchdb]: https://pouchdb.com/

[orbitdb]: https://github.com/orbitdb/orbit-db

[ipfs-log]: https://github.com/orbitdb/ipfs-log

A small connector for big things.

CubeSatDB uses [PouchDB][pouchdb] and the [ipfs-log][ipfs-log] module from [OrbitDB][orbitdb] to store, index, and replicate documents between peers over IPFS _and_ CouchDB.

## Install

Install CubeSatDB using [npm](http://npmjs.com/):

```bash
$ npm install -S cubesat-db
```

## Usage

CubeSatDB is just a database: you can add, update, remove, and query records:

```javascript
const CubeSatDB = require('cubesat-db')

let cube = new CubeSatDB('hello-world')

cube.all().then(function (result) {
    // Print all of the documents in the db
    console.log(result)
    // Add a document to the database
    return cube.post({ status: 'ok', date: Date.now() })
}).then(function () {
    // Add a document with a known ID
    return cube.put({ _id: 'mars-rover', status: 'landing' })
}).then(function (result) {
    // extract the updated document from the response
    let doc = result.payload
    // Remove a document
    return cube.del(doc)
})
```

But you can also replicate it between computers:

```javascript
// on one computer:
let cube = new CubeSatDB('hello-world')
/*
... add documents ...
then get the cube's multihash
 */
cube.toMultihash().then(function (hash) {
    // pass this value to your friend
    console.log(hash)
})

// on another computer
const hash = '...' // that value from above
let cube = new CubeSatDB({ hash, name: 'hello-world' })
cube.load().then(function () {
    console.log('Cube up to date!')
})
```

And you can join one CubeSatDB instances with another. It will merge all the entries from the other that it does not already have:

```javascript
let cube1 = new CubeSatDB('cube-1')
let cube2 = new CubeSatDB('cube-2', { ipfs: cube1.ipfs })
Promise.all([
    cube1.post.bind(cube1, { status: 'ok' })
    cube2.post.bind(cube2, { status: 'fine' })
]).then(function () {
    return cube1.join(cube2)
}).then(function () {
    // cube1 has all the values in cube2
    // but cube2 doesn't have cube1's records
    console.log(cube1.log.values)
    })
```

If you have any questions, please [leave an issue!](https://github.com/garbados/cubesat-db/issues)

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [CubeSatDB](#cubesatdb)
    -   [put](#put)
    -   [post](#post)
    -   [get](#get)
    -   [all](#all)
    -   [del](#del)
    -   [find](#find)
    -   [query](#query)
    -   [join](#join)
    -   [load](#load)
    -   [validate](#validate)
    -   [toMultihash](#tomultihash)
    -   [hash](#hash)
    -   [name](#name)
    -   [pouch](#pouch)
    -   [log](#log)
    -   [ipfs](#ipfs)
    -   [Error](#error)

### CubeSatDB

**Parameters**

-   `name` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** A name, URL (of a CouchDB instance), or multihash (of an IPFS log)
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** An object of settings and configuration values. (optional, default `{}`)
    -   `options.ipfs` **(IPFS | [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object))** [description]
    -   `options.pouch` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** [description]
    -   `options._IpfsLog` **IpfsLog** [description]
    -   `options._IPFS` **IPFS** [description]
    -   `options._PouchDB` **PouchDB** [description]

#### put

Add or update a document.

If you pass an array of docs,
it will pass each of them to this method
and resolve once they all resolve.

**Parameters**

-   `doc` **([Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) \| [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array))** The document to save, or an array of such documents.
    -   `doc._id` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The document's ID. Required for `.put()`

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### post

Post a document to the store, creating an ID for it.
To add a document with an ID, see `.put()`.

If you pass an array of docs,
it will pass each of them to this method
and resolve once they all resolve.

**Parameters**

-   `doc` **([Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) \| [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array))** The document to save, or an array of such documents.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### get

Retrieve a document. Wrapper around [PouchDB#get()](https://pouchdb.com/api.html#fetch_document)

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** A promise that resolves to the specified document.

#### all

Retrieve all documents. Wrapper around [PouchDB#allDocs](https://pouchdb.com/api.html#batch_fetch)

**Parameters**

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**  (optional, default `{}`)

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>>** Resolves to an array of retrieved documents.

#### del

Delete a document using its ID and revision value.

**Parameters**

-   `doc` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The document to delete.
    -   `doc._id` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The document's ID. Required.
    -   `doc._rev` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The document's revision value. Required.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### find

Wrapper around [PouchDB#find](https://pouchdb.com/api.html#query_index) that returns each selected document.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>>** Selected documents.

#### query

Alias to [PouchDB#query()](https://pouchdb.com/api.html#query_database).

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** Query result.

#### join

Merges another CubeSatDB or IpfsLog into this one.

**Parameters**

-   `log` **(IpfsLog | [CubeSatDB](#cubesatdb))** An instance of IpfsLog or CubeSatDB.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** [description]

#### load

Loads the oplog from the store's IPFS hash.

Errors out if the store wasnt constructed with a hash
or hasn't established one yet using `.toMultihash()`.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** A promise that resolves once the store has loaded.

#### validate

A document validator. It makes sure a document is
an object but not an array.

Subclasses can extend this method to enforce a schema.

**Parameters**

-   `doc` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** A document.


-   Throws **CubeError** An error about the document.

#### toMultihash

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** The multihash for this store. Use this value to clone the store.

#### hash

-   Throws **CubeError** If `CubeSatDB#toMultihash()` has not been called yet.

Returns **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The multihash for the store.

#### name

Returns **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The name of this database.

#### pouch

Returns **PouchDB** The CubeSatDB instance's instance of PouchDB.

#### log

Returns **IpfsLog** The CubeSatDB instance's instance of IpfsLog.

#### ipfs

Returns **IPFS** The CubeSatDB instance's instance of an IPFS node.

#### Error

A subclass of Error for describing cube-related problems.

Returns **CubeError** 

## Development

Get the source with [git](http://git-scm.org/):

```bash
git clone https://github.com/garbados/cubesat-db
cd cubesat-db
npm i
npm test
```

## Contributions

All contributions are welcome: bug reports, feature requests, "why doesn't this work" questions, patches for fixes and features, etc. For all of the above, [file an issue](https://github.com/garbados/cubesat-db/issues) or [submit a pull request](https://github.com/garbados/cubesat-db/pulls).

## License

[Apache-2.0](https://www.apache.org/licenses/LICENSE-2.0)
